<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ORFEAS MATERIAL STUDIO - PBR Material & Lighting System</title>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/OBJLoader.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
        }

        /* Left Panel - Controls */
        .controls-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
            overflow-y: auto;
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: rgba(231, 76, 60, 0.5);
            border-radius: 4px;
        }

        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #e74c3c;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #95a5a6;
            font-size: 0.9rem;
        }

        .section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1rem;
            color: #3498db;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #ecf0f1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .material-btn {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
        }

        .material-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(231, 76, 60, 0.5);
            transform: translateY(-2px);
        }

        .material-btn.active {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }

        .material-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .lighting-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .lighting-btn {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .lighting-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(52, 152, 219, 0.5);
        }

        .lighting-btn.active {
            background: rgba(52, 152, 219, 0.3);
            border-color: #3498db;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.4);
        }

        .lighting-icon {
            font-size: 1.5rem;
        }

        .slider-container {
            margin-bottom: 1rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            border-radius: 3px;
            -webkit-appearance: none;
            appearance: none; /* Standard property for cross-browser compatibility */
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none; /* Standard property for cross-browser compatibility */
            width: 16px;
            height: 16px;
            background: #e74c3c;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #e74c3c;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.4);
        }

        /* Right Panel - 3D Viewport */
        .viewport-container {
            position: relative;
            background: #000;
        }

        #viewport {
            width: 100%;
            height: 100vh;
            display: block;
        }

        .viewport-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .viewport-stats {
            font-size: 0.85rem;
            color: #95a5a6;
        }

        .viewport-stats div {
            margin-bottom: 0.25rem;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-green {
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
        }

        .status-yellow {
            background: #f39c12;
            box-shadow: 0 0 10px #f39c12;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e74c3c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .upload-zone {
            border: 2px dashed rgba(231, 76, 60, 0.5);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .upload-zone:hover {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #e74c3c;
        }

        .upload-text {
            font-size: 0.9rem;
            color: #95a5a6;
        }

        input[type="file"] {
            display: none;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .controls-panel {
                height: auto;
                max-height: 50vh;
            }

            .viewport-container {
                height: 50vh;
            }

            #viewport {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div style="color: white; font-size: 1.2rem;">Loading 3D Model...</div>
        </div>
    </div>

    <div class="container">
        <!-- Left Panel - Material & Lighting Controls -->
        <div class="controls-panel">
            <div class="header">
                <h1> MATERIAL STUDIO</h1>
                <p>Professional PBR Material & Lighting System</p>
            </div>

            <!-- Model Upload -->
            <div class="section">
                <div class="section-title"> Load 3D Model</div>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon"></div>
                    <div class="upload-text">Click or drag STL/OBJ file</div>
                    <input type="file" id="fileInput" accept=".stl,.obj">
                </div>
                <button class="btn btn-secondary" id="loadSampleBtn">
                     Load Sample Model
                </button>
            </div>

            <!-- PBR Materials -->
            <div class="section">
                <div class="section-title"> PBR Materials</div>
                <div class="material-grid">
                    <button class="material-btn active" data-material="metal">
                        <div class="material-icon"></div>
                        <div>Metal</div>
                    </button>
                    <button class="material-btn" data-material="plastic">
                        <div class="material-icon"></div>
                        <div>Plastic</div>
                    </button>
                    <button class="material-btn" data-material="wood">
                        <div class="material-icon"></div>
                        <div>Wood</div>
                    </button>
                    <button class="material-btn" data-material="glass">
                        <div class="material-icon"></div>
                        <div>Glass</div>
                    </button>
                    <button class="material-btn" data-material="ceramic">
                        <div class="material-icon"></div>
                        <div>Ceramic</div>
                    </button>
                    <button class="material-btn" data-material="rubber">
                        <div class="material-icon"></div>
                        <div>Rubber</div>
                    </button>
                </div>
            </div>

            <!-- Material Properties -->
            <div class="section">
                <div class="section-title"> Material Properties</div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Metalness</span>
                        <span id="metalnessValue">0.8</span>
                    </div>
                    <input type="range" class="slider" id="metalnessSlider"
                           min="0" max="1" step="0.01" value="0.8">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Roughness</span>
                        <span id="roughnessValue">0.3</span>
                    </div>
                    <input type="range" class="slider" id="roughnessSlider"
                           min="0" max="1" step="0.01" value="0.3">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Reflectivity</span>
                        <span id="reflectivityValue">0.5</span>
                    </div>
                    <input type="range" class="slider" id="reflectivitySlider"
                           min="0" max="1" step="0.01" value="0.5">
                </div>

                <div class="control-group">
                    <div class="control-label">Base Color</div>
                    <input type="color" class="color-picker" id="colorPicker" value="#888888">
                </div>
            </div>

            <!-- Lighting Environments -->
            <div class="section">
                <div class="section-title"> HDR Lighting</div>
                <div class="lighting-grid">
                    <button class="lighting-btn active" data-lighting="studio">
                        <span class="lighting-icon"></span>
                        <div>
                            <div style="font-weight: 600;">Studio</div>
                            <div style="font-size: 0.8rem; color: #95a5a6;">Soft, professional lighting</div>
                        </div>
                    </button>
                    <button class="lighting-btn" data-lighting="outdoor">
                        <span class="lighting-icon"></span>
                        <div>
                            <div style="font-weight: 600;">Outdoor</div>
                            <div style="font-size: 0.8rem; color: #95a5a6;">Natural sunlight</div>
                        </div>
                    </button>
                    <button class="lighting-btn" data-lighting="dramatic">
                        <span class="lighting-icon"></span>
                        <div>
                            <div style="font-weight: 600;">Dramatic</div>
                            <div style="font-size: 0.8rem; color: #95a5a6;">High contrast shadows</div>
                        </div>
                    </button>
                    <button class="lighting-btn" data-lighting="night">
                        <span class="lighting-icon"></span>
                        <div>
                            <div style="font-weight: 600;">Night</div>
                            <div style="font-size: 0.8rem; color: #95a5a6;">Dark with highlights</div>
                        </div>
                    </button>
                    <button class="lighting-btn" data-lighting="warm">
                        <span class="lighting-icon"></span>
                        <div>
                            <div style="font-weight: 600;">Warm</div>
                            <div style="font-size: 0.8rem; color: #95a5a6;">Cozy, warm tones</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Lighting Controls -->
            <div class="section">
                <div class="section-title">âš¡ Lighting Controls</div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Intensity</span>
                        <span id="intensityValue">1.0</span>
                    </div>
                    <input type="range" class="slider" id="intensitySlider"
                           min="0" max="3" step="0.1" value="1.0">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Ambient Light</span>
                        <span id="ambientValue">0.3</span>
                    </div>
                    <input type="range" class="slider" id="ambientSlider"
                           min="0" max="1" step="0.05" value="0.3">
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Shadow Intensity</span>
                        <span id="shadowValue">0.5</span>
                    </div>
                    <input type="range" class="slider" id="shadowSlider"
                           min="0" max="1" step="0.05" value="0.5">
                </div>
            </div>

            <!-- Export -->
            <div class="section">
                <div class="section-title"> Export</div>
                <button class="btn btn-primary" id="exportBtn">
                     Export with Material Data
                </button>
                <button class="btn btn-secondary" id="screenshotBtn">
                     Take Screenshot
                </button>
            </div>
        </div>

        <!-- Right Panel - 3D Viewport -->
        <div class="viewport-container">
            <canvas id="viewport"></canvas>

            <div class="viewport-overlay">
                <div class="viewport-stats">
                    <div>
                        <span class="status-indicator status-green"></span>
                        <strong>WebGL</strong>
                    </div>
                    <div>FPS: <span id="fpsCounter">60</span></div>
                    <div>Triangles: <span id="triangleCount">0</span></div>
                    <div>Material: <span id="currentMaterial">Metal</span></div>
                    <div>Lighting: <span id="currentLighting">Studio</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // ORFEAS MATERIAL STUDIO - Phase 2.3 Maximum Efficiency
        // ============================================================================

        let scene, camera, renderer, controls, model;
        let currentMaterial = 'metal';
        let currentLighting = 'studio';
        let lights = {};

        // Initialize Three.js Scene
        function initThreeJS() {
            const canvas = document.getElementById('viewport');
            const container = canvas.parentElement;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Camera
            camera = new THREE.PerspectiveCamera(
                50,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            camera.position.set(0, 5, 10);

            // Renderer
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 50;

            // Setup lighting
            setupLighting();

            // Load sample model
            loadSampleModel();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation loop
            animate();

            console.log(' Three.js initialized');
        }

        function setupLighting() {
            // Ambient light
            lights.ambient = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(lights.ambient);

            // Directional light (main)
            lights.main = new THREE.DirectionalLight(0xffffff, 1.0);
            lights.main.position.set(5, 10, 5);
            lights.main.castShadow = true;
            lights.main.shadow.camera.near = 0.1;
            lights.main.shadow.camera.far = 50;
            lights.main.shadow.camera.left = -10;
            lights.main.shadow.camera.right = 10;
            lights.main.shadow.camera.top = 10;
            lights.main.shadow.camera.bottom = -10;
            lights.main.shadow.mapSize.width = 2048;
            lights.main.shadow.mapSize.height = 2048;
            scene.add(lights.main);

            // Fill light
            lights.fill = new THREE.DirectionalLight(0xffffff, 0.3);
            lights.fill.position.set(-5, 5, -5);
            scene.add(lights.fill);

            // Back light
            lights.back = new THREE.DirectionalLight(0xffffff, 0.2);
            lights.back.position.set(0, 5, -10);
            scene.add(lights.back);

            // Ground plane for shadows
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.ShadowMaterial({ opacity: 0.3 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function loadSampleModel() {
            // Create a sample sphere for testing
            const geometry = new THREE.SphereGeometry(2, 64, 64);
            const material = createPBRMaterial('metal');

            if (model) {
                scene.remove(model);
            }

            model = new THREE.Mesh(geometry, material);
            model.castShadow = true;
            model.receiveShadow = true;
            scene.add(model);

            updateTriangleCount(geometry);

            console.log(' Sample model loaded');
        }

        function createPBRMaterial(type) {
            const materialPresets = {
                metal: {
                    color: 0x888888,
                    metalness: 0.8,
                    roughness: 0.3,
                    reflectivity: 0.5
                },
                plastic: {
                    color: 0x3498db,
                    metalness: 0.0,
                    roughness: 0.5,
                    reflectivity: 0.3
                },
                wood: {
                    color: 0x8B4513,
                    metalness: 0.0,
                    roughness: 0.8,
                    reflectivity: 0.1
                },
                glass: {
                    color: 0xffffff,
                    metalness: 0.0,
                    roughness: 0.1,
                    reflectivity: 0.9,
                    transparent: true,
                    opacity: 0.6
                },
                ceramic: {
                    color: 0xf5f5dc,
                    metalness: 0.0,
                    roughness: 0.4,
                    reflectivity: 0.4
                },
                rubber: {
                    color: 0x2c3e50,
                    metalness: 0.0,
                    roughness: 0.9,
                    reflectivity: 0.1
                }
            };

            const preset = materialPresets[type] || materialPresets.metal;

            const material = new THREE.MeshStandardMaterial({
                color: preset.color,
                metalness: preset.metalness,
                roughness: preset.roughness,
                reflectivity: preset.reflectivity,
                transparent: preset.transparent || false,
                opacity: preset.opacity || 1.0,
                side: THREE.DoubleSide
            });

            // Update UI sliders
            document.getElementById('metalnessSlider').value = preset.metalness;
            document.getElementById('metalnessValue').textContent = preset.metalness.toFixed(2);
            document.getElementById('roughnessSlider').value = preset.roughness;
            document.getElementById('roughnessValue').textContent = preset.roughness.toFixed(2);
            document.getElementById('reflectivitySlider').value = preset.reflectivity;
            document.getElementById('reflectivityValue').textContent = preset.reflectivity.toFixed(2);
            document.getElementById('colorPicker').value = '#' + preset.color.toString(16).padStart(6, '0');

            return material;
        }

        function applyLighting(type) {
            const lightingPresets = {
                studio: {
                    ambient: 0.3,
                    main: { intensity: 1.0, position: [5, 10, 5], color: 0xffffff },
                    fill: { intensity: 0.3, position: [-5, 5, -5] },
                    back: { intensity: 0.2, position: [0, 5, -10] },
                    background: 0x1a1a1a
                },
                outdoor: {
                    ambient: 0.5,
                    main: { intensity: 1.5, position: [10, 15, 5], color: 0xffffee },
                    fill: { intensity: 0.4, position: [-8, 8, -5] },
                    back: { intensity: 0.3, position: [0, 10, -15] },
                    background: 0x87CEEB
                },
                dramatic: {
                    ambient: 0.1,
                    main: { intensity: 2.0, position: [10, 10, 2], color: 0xffffff },
                    fill: { intensity: 0.1, position: [-10, 5, -5] },
                    back: { intensity: 0.05, position: [0, 5, -10] },
                    background: 0x0a0a0a
                },
                night: {
                    ambient: 0.2,
                    main: { intensity: 0.8, position: [3, 8, 3], color: 0x6699ff },
                    fill: { intensity: 0.2, position: [-5, 5, -5] },
                    back: { intensity: 0.3, position: [0, 5, -10] },
                    background: 0x0f0f1e
                },
                warm: {
                    ambient: 0.4,
                    main: { intensity: 1.2, position: [5, 10, 5], color: 0xffddaa },
                    fill: { intensity: 0.4, position: [-5, 5, -5] },
                    back: { intensity: 0.2, position: [0, 5, -10] },
                    background: 0x2a1f1a
                }
            };

            const preset = lightingPresets[type] || lightingPresets.studio;

            // Update lights
            lights.ambient.intensity = preset.ambient;
            lights.main.intensity = preset.main.intensity;
            lights.main.position.set(...preset.main.position);
            lights.main.color.setHex(preset.main.color);
            lights.fill.intensity = preset.fill.intensity;
            lights.fill.position.set(...preset.fill.position);
            lights.back.intensity = preset.back.intensity;
            lights.back.position.set(...preset.back.position);

            // Update background
            scene.background.setHex(preset.background);

            console.log(` Lighting: ${type}`);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);

            // Update FPS counter (simplified)
            const fps = Math.round(1000 / renderer.info.render.frame);
            document.getElementById('fpsCounter').textContent = Math.min(fps, 60);
        }

        function onWindowResize() {
            const container = document.getElementById('viewport').parentElement;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function updateTriangleCount(geometry) {
            const count = geometry.index ? geometry.index.count / 3 : geometry.attributes.position.count / 3;
            document.getElementById('triangleCount').textContent = Math.round(count).toLocaleString();
        }

        // ============================================================================
        // Event Handlers
        // ============================================================================

        // Material Selection
        document.querySelectorAll('.material-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const materialType = btn.dataset.material;
                currentMaterial = materialType;

                if (model) {
                    model.material = createPBRMaterial(materialType);
                }

                document.getElementById('currentMaterial').textContent =
                    materialType.charAt(0).toUpperCase() + materialType.slice(1);
            });
        });

        // Lighting Selection
        document.querySelectorAll('.lighting-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.lighting-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const lightingType = btn.dataset.lighting;
                currentLighting = lightingType;
                applyLighting(lightingType);

                document.getElementById('currentLighting').textContent =
                    lightingType.charAt(0).toUpperCase() + lightingType.slice(1);
            });
        });

        // Material Property Sliders
        document.getElementById('metalnessSlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('metalnessValue').textContent = value.toFixed(2);
            if (model && model.material) {
                model.material.metalness = value;
            }
        });

        document.getElementById('roughnessSlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('roughnessValue').textContent = value.toFixed(2);
            if (model && model.material) {
                model.material.roughness = value;
            }
        });

        document.getElementById('reflectivitySlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('reflectivityValue').textContent = value.toFixed(2);
            if (model && model.material) {
                model.material.reflectivity = value;
            }
        });

        document.getElementById('colorPicker').addEventListener('input', (e) => {
            const color = new THREE.Color(e.target.value);
            if (model && model.material) {
                model.material.color = color;
            }
        });

        // Lighting Control Sliders
        document.getElementById('intensitySlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('intensityValue').textContent = value.toFixed(1);
            lights.main.intensity = value;
        });

        document.getElementById('ambientSlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('ambientValue').textContent = value.toFixed(2);
            lights.ambient.intensity = value;
        });

        document.getElementById('shadowSlider').addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            document.getElementById('shadowValue').textContent = value.toFixed(2);
            // Adjust shadow opacity (if ground plane exists)
            const ground = scene.children.find(obj => obj.material instanceof THREE.ShadowMaterial);
            if (ground) {
                ground.material.opacity = value;
            }
        });

        // File Upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');

        uploadZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadModelFile(file);
            }
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = '#e74c3c';
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.style.borderColor = 'rgba(231, 76, 60, 0.5)';
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.style.borderColor = 'rgba(231, 76, 60, 0.5)';
            const file = e.dataTransfer.files[0];
            if (file) {
                loadModelFile(file);
            }
        });

        function loadModelFile(file) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const extension = file.name.split('.').pop().toLowerCase();

                if (extension === 'stl') {
                    const loader = new THREE.STLLoader();
                    const geometry = loader.parse(e.target.result);
                    geometry.center();
                    geometry.computeVertexNormals();

                    const material = createPBRMaterial(currentMaterial);

                    if (model) {
                        scene.remove(model);
                    }

                    model = new THREE.Mesh(geometry, material);
                    model.castShadow = true;
                    model.receiveShadow = true;

                    // Scale model to reasonable size
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 5 / maxDim;
                    model.scale.setScalar(scale);

                    scene.add(model);
                    updateTriangleCount(geometry);

                    console.log(' STL model loaded:', file.name);
                } else if (extension === 'obj') {
                    const loader = new THREE.OBJLoader();
                    const object = loader.parse(e.target.result);

                    if (model) {
                        scene.remove(model);
                    }

                    object.traverse(child => {
                        if (child instanceof THREE.Mesh) {
                            child.material = createPBRMaterial(currentMaterial);
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });

                    // Scale and center
                    const box = new THREE.Box3().setFromObject(object);
                    const center = box.getCenter(new THREE.Vector3());
                    object.position.sub(center);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 5 / maxDim;
                    object.scale.setScalar(scale);

                    model = object;
                    scene.add(model);

                    console.log(' OBJ model loaded:', file.name);
                }

                loadingOverlay.classList.add('hidden');
            };

            if (file.name.endsWith('.stl')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        // Load Sample Button
        document.getElementById('loadSampleBtn').addEventListener('click', loadSampleModel);

        // Export Button
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!model) {
                alert('No model loaded!');
                return;
            }

            const materialData = {
                type: currentMaterial,
                metalness: model.material.metalness,
                roughness: model.material.roughness,
                reflectivity: model.material.reflectivity,
                color: '#' + model.material.color.getHexString(),
                lighting: currentLighting
            };

            const blob = new Blob([JSON.stringify(materialData, null, 2)],
                { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'material_data.json';
            a.click();
            URL.revokeObjectURL(url);

            console.log(' Material data exported');
        });

        // Screenshot Button
        document.getElementById('screenshotBtn').addEventListener('click', () => {
            renderer.render(scene, camera);
            const imgData = renderer.domElement.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = imgData;
            a.download = 'orfeas_material_preview.png';
            a.click();

            console.log(' Screenshot captured');
        });

        // ============================================================================
        // Initialize on page load
        // ============================================================================

        window.addEventListener('DOMContentLoaded', () => {
            console.log(' ORFEAS MATERIAL STUDIO INITIALIZED');
            initThreeJS();

            // Hide loading overlay after init
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 1000);
        });
    </script>
</body>
</html>
